<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>🔍 بحث عن الرسيفرات</title>
<style>
:root {
  --bg:#0f1724; --card:#0b1220; --txt:white; --accent:#01c38d; --glass:rgba(255,255,255,0.04);
}
body { background:var(--bg); font-family:"Tajawal",sans-serif; margin:0; padding:20px; color:var(--txt);}
.container{max-width:800px;margin:auto;}
.search-box {background:var(--glass);border:1px solid #1e293b;padding:12px;border-radius:10px;margin-bottom:20px;display:flex;gap:10px;}
input {flex:1;background:none;border:none;color:var(--txt);padding:10px;outline:none;}

.results {display:flex;flex-direction:column;gap:10px;}
.card {background:var(--card);padding:8px 12px;border-radius:10px;display:flex;gap:10px;align-items:center;border:1px solid #1f2a3a;cursor:pointer;transition:0.25s;}
.card:hover {border-color:var(--accent);}
.card img {width:60px;height:40px;object-fit:cover;border-radius:6px;flex-shrink:0;}
.card-info {display:flex;flex-direction:column;flex:1;min-width:0;}
.card-info h3 {margin:0;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.card-info p {margin:2px 0 0;font-size:13px;color:#8ef;}
.new-badge {background:#01c38d;color:#012;padding:2px 6px;border-radius:6px;font-size:11px;font-weight:bold;margin-left:6px;}

/* البطاقة المنبثقة */
.overlay{
  position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7);
  display:none; z-index:1000;
}
.overlay.show { display:block; }

.card-popup{
  position: fixed; top:50%; left:50%; transform: translate(-50%,-50%);
  background: var(--card); border-radius:16px; width:90%; max-width:400px; padding:15px;
  box-shadow:0 10px 30px rgba(0,0,0,0.4); z-index:1001;
}
.close-btn{position:absolute;top:10px;left:14px;background:none;border:none;color:#fff;font-size:24px;font-weight:bold;cursor:pointer;line-height:1;}
.close-btn:hover{color:var(--accent);}
.popup-img{width:100%;height:auto;max-height:180px;object-fit:cover;border-radius:12px;margin-bottom:12px;}
.popup-info h2{margin:0 0 6px 0;font-size:18px;}
.popup-info p{margin:2px 0;color:#8ef;font-size:13px;}
.popup-actions{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;}
.popup-actions a{flex:1;justify-content:center;background:var(--accent);color:#012;padding:8px;border-radius:10px;text-decoration:none;display:flex;align-items:center;gap:5px;}

/* الجوال */
@media(max-width:600px){
  .card {flex-direction:row;align-items:center;padding:6px;}
  .card img{width:50px;height:35px;}
  .card-info h3{font-size:14px;}
  .card-info p{font-size:12px;}
  .card-popup{padding:12px;}
  .popup-img{max-height:150px;}
  .popup-info h2{font-size:16px;}
  .popup-info p{font-size:12px;}
  .popup-actions a{font-size:12px;padding:6px;}
}
</style>
</head>
<body>

<div class="container">
  <h2>🔍 بحث عن الرسيفرات</h2>
  <div class="search-box">
    <input id="searchInput" type="text" placeholder="اكتب اسم الرسيفر...">
  </div>
  <div id="results" class="results"></div>
</div>

<!-- البطاقة المنبثقة -->
<div id="overlay" class="overlay">
  <div class="card-popup">
    <button id="closePopup" class="close-btn">✖</button>
    <img id="popupImg" class="popup-img" src="" alt="">
    <div class="popup-info">
      <h2 id="popupName"></h2>
      <p id="popupVersion"></p>
      <p id="popupDate"></p>
      <p id="popupSize"></p>
    </div>
    <div class="popup-actions">
      <a id="popupDownload" href="#" target="_blank">⬇ تحميل</a>
      <a id="popupWhats" href="#" target="_blank">واتساب</a>
    </div>
  </div>
</div>

<script>
// الشيتات
const SHEET_ID = "2PACX-1vQXW9rev-EPbzS_pXVSa3xoylhsjYwHFE8n0xa9wDoxrkMdFgsn8srViSagCj8kqI-iHpEwpk5w2FuF";
const SHEETS = [
  { name: "Sheet1", gid: "1337227866" },
// مثال
];
let allDevices = [];

// رابط CSV لكل شيت
function getCSVUrl(sheet){ return `https://docs.google.com/spreadsheets/d/e/${SHEET_ID}/pub?output=csv&gid=${sheet.gid}`; }

// استخراج الإصدار والتاريخ مع زيادة يوم
function parseURLData(url=""){
  let versionMatch = url.match(/V(\d+(?:\.\d+)?)/i);
  let version = versionMatch ? "V"+versionMatch[1] : "-";
  let dateMatch = url.match(/(\d{8})/);
  let releaseDate="-"; let isNew=false;
  if(dateMatch){
    let d = dateMatch[1];
    let updateDate = new Date(`${d.slice(4,8)}-${d.slice(2,4)}-${d.slice(0,2)}`);
    updateDate.setDate(updateDate.getDate()+1);
    const day = String(updateDate.getDate()).padStart(2,'0');
    const month = String(updateDate.getMonth()+1).padStart(2,'0');
    const year = updateDate.getFullYear();
    releaseDate = `${day}/${month}/${year}`;
    const today = new Date();
    const diffDays = (today - updateDate)/(1000*60*60*24);
    if(diffDays <= 15 && diffDays >=0) isNew=true;
  }
  return {version, releaseDate, isNew};
}

// CSV -> JSON
function parseCSV(csv){
  const rows = csv.split(/\r?\n/).map(r=>r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/));
  const headers = rows[0];
  return rows.slice(1).map(row=>{
    let item={};
    headers.forEach((h,i)=>{ item[h.trim()] = row[i]?row[i].trim().replace(/"/g,""):"-"; });
    const extra = parseURLData(item.url);
    item.version=extra.version; item.date=extra.releaseDate; item.isNew=extra.isNew;
    item.name = item.name || "-"; item.size=item.size||"-"; item.image=item.image||"";
    return item;
  });
}

// جلب كل الشيتات
async function fetchSheets(){
  for(let sheet of SHEETS){
    try{
      const res = await fetch(getCSVUrl(sheet));
      const csv = await res.text();
      allDevices.push(...parseCSV(csv));
    }catch(err){ console.error("فشل جلب:",sheet.name,err); }
  }
  showResults(allDevices);
}
fetchSheets();
// بعد تحميل كل البيانات، تحقق من ?search= في الرابط
fetchSheets().then(() => {
  const urlParams = new URLSearchParams(window.location.search);
  const searchQuery = urlParams.get('search');
  if(searchQuery){
    searchInput.value = searchQuery; // ضع القيمة في مربع البحث
    searchInput.dispatchEvent(new Event('input')); // شغّل البحث تلقائياً
  }
});

// البحث الحي
document.getElementById("searchInput").addEventListener("input",()=>{
  let q = searchInput.value.trim().toLowerCase();
  let filtered = allDevices.filter(d=> (d.name||"").toLowerCase().includes(q));
  showResults(filtered);
});

// عرض النتائج مع فرز الجديد أولًا
function showResults(list){
  let box = document.getElementById("results");
  box.innerHTML="";
  if(!list.length){ box.innerHTML="<p>لا توجد نتائج</p>"; return; }
  list.sort((a,b)=> a.isNew && !b.isNew?-1: !a.isNew && b.isNew?1:0);
  list.forEach(item=>{
    box.innerHTML+=`
      <div class="card" onclick='showPopup(${JSON.stringify(item).replace(/'/g,"\\'")})'>
        ${item.image?`<img src="${item.image}" alt="${item.name}">`:""}
        <div class="card-info">
          <h3>${item.name} ${item.isNew?'<span class="new-badge">جديد 🔥</span>':""}</h3>
          <p>الإصدار: ${item.version} | التاريخ: ${item.date}</p>
        </div>
      </div>
    `;
  });
}

// عرض البطاقة المنبثقة
const overlay = document.getElementById("overlay");
const popupImg = document.getElementById("popupImg");
const popupName = document.getElementById("popupName");
const popupVersion = document.getElementById("popupVersion");
const popupDate = document.getElementById("popupDate");
const popupSize = document.getElementById("popupSize");
const popupDownload = document.getElementById("popupDownload");
const popupWhats = document.getElementById("popupWhats");
const closePopup = document.getElementById("closePopup");

function showPopup(item){
  popupImg.src = item.image || "";
  popupName.textContent = item.name;
  popupVersion.textContent = "الإصدار: " + item.version;
  popupDate.textContent = "تاريخ التحديث: " + item.date;
  popupSize.textContent = "الحجم: " + item.size;
  popupDownload.href = item.url;

  // تعديل رابط واتساب ليشمل المصدر
// رابط واتساب يضع اسم الرسيفر في البحث ضمن الموقع
const searchURL = `${window.location.origin}${window.location.pathname}?search=${encodeURIComponent(item.name)}`;
const whatsappText = `📡 ${item.name}
🔢 الإصدار: ${item.version}
📅 التاريخ: ${item.date}
🔗 الرابط: ${searchURL}`;

popupWhats.href = "https://wa.me/?text=" + encodeURIComponent(whatsappText);


  overlay.classList.add("show");

  // إضافة سجل جديد للرجوع
  history.pushState({popup:true}, "");
}
// زر الإغلاق
closePopup.onclick = closePopupFunc;

// النقر خارج البطاقة
overlay.onclick = e => {
  if(e.target === overlay) closePopupFunc();
}

// زر الرجوع في الجوال
window.addEventListener("popstate", e => {
  if(overlay.classList.contains("show")) overlay.classList.remove("show");
});

function closePopupFunc(){
  overlay.classList.remove("show");
  // إزالة سجل الرجوع إذا كان هذا هو سجل popup
  if(history.state && history.state.popup){
    history.replaceState(null, "");
  }
}


</script>

</body>
</html>
